---
alwaysApply: false
---

# Template de Tarefa: Tabelas de Autenticação e Permissões

## INSTRUÇÕES DE USO

Quando este template for referenciado, você deve:

1. **Localizar e verificar o banco de dados:**
   - Ler o arquivo `Database/docker-compose.yml` para identificar o tipo de banco (PostgreSQL, SQL Server, MySQL, etc.)
   - Ler o arquivo `Database/create-database.sql` para verificar a estrutura existente

2. **Verificar conflitos:**
   - Procurar no `create-database.sql` se alguma das seguintes tabelas já existe:
     - Users
     - Sessions
     - Profiles
     - Modules
     - Functionalities
     - ProfilesXFunctionalities
     - UsersXProfiles
     - UsersHistory (tabela de histórico, SQL Server)
     - SessionsHistory (tabela de histórico, SQL Server)
     - ProfilesHistory (tabela de histórico, SQL Server)
     - ModulesHistory (tabela de histórico, SQL Server)
     - FunctionalitiesHistory (tabela de histórico, SQL Server)
     - ProfilesXFunctionalitiesHistory (tabela de histórico, SQL Server)
     - UsersXProfilesHistory (tabela de histórico, SQL Server)
   - Se encontrar conflitos, **PARAR e reportar ao usuário** antes de continuar

3. **Adaptar o código SQL:**
   - As tabelas abaixo estão definidas em **SQL Server** (formato original)
   - Adaptar para o banco de dados identificado no docker-compose.yml:
     - **PostgreSQL**: 
       - UNIQUEIDENTIFIER → UUID
       - NVARCHAR → VARCHAR
       - DATETIME2 → TIMESTAMP
       - NEWID() → gen_random_uuid()
       - SYSUTCDATETIME() → NOW()
       - Remover SYSTEM_VERSIONING e PERIOD FOR SYSTEM_TIME (PostgreSQL não suporta temporal tables da mesma forma)
       - IF NOT EXISTS → CREATE TABLE IF NOT EXISTS
       - Remover GO (não é necessário no PostgreSQL)
     - **MySQL**: 
       - UNIQUEIDENTIFIER → CHAR(36) ou BINARY(16) com UUID()
       - NVARCHAR → VARCHAR
       - DATETIME2 → DATETIME ou TIMESTAMP
       - Remover SYSTEM_VERSIONING
     - **SQL Server**: Usar código original (já está em SQL Server)
   - **Ordem de criação importante:** 
     - Criar Users primeiro (outras tabelas referenciam)
     - Depois Sessions, Profiles, Modules
     - Depois Functionalities (referencia Modules)
     - Por último ProfilesXFunctionalities e UsersXProfiles (tabelas de relacionamento)

4. **Incluir no create-database.sql:**
   - Adicionar as tabelas adaptadas ao arquivo `Database/create-database.sql`
   - Não criar arquivos .sql adicionais
   - Não criar arquivos .md ou resumos
   - Não se conectar ao banco de dados diretamente

5. **Reportar:**
   - Informar quais tabelas foram adicionadas
   - Informar adaptações realizadas para o banco de dados
   - Não criar documentação adicional

---

## TABELAS DE AUTENTICAÇÃO E PERMISSÕES

**Formato original: SQL Server**

-- ================================================================
-- 1. USERS & AUTHENTICATION
-- ================================================================

-- Users table - centraliza todos os usuários da plataforma
IF NOT EXISTS (SELECT * FROM sys.tables WHERE name = 'Users')
BEGIN
    CREATE TABLE Users (
        UserId UNIQUEIDENTIFIER NOT NULL DEFAULT NEWID(),
        Email NVARCHAR(255) NOT NULL,
        PasswordHash NVARCHAR(512) NOT NULL,
        PasswordSalt NVARCHAR(512) NOT NULL,
        Name NVARCHAR(255) NOT NULL,
        Gender VARCHAR(20) NOT NULL DEFAULT 'Unknown',
        BirthDate DATE,
        ProfileCompletion INT NOT NULL DEFAULT 0,
        PhotoFileName VARCHAR(255),
        PhotoRelativePath VARCHAR(500),
        CreatedBy NVARCHAR(255) NOT NULL,
        CreatedDate DATETIME2 NOT NULL DEFAULT SYSUTCDATETIME(),
        ModifiedBy NVARCHAR(255) NOT NULL,
        ModifiedDate DATETIME2 NOT NULL DEFAULT SYSUTCDATETIME(),
        SysStartTime DATETIME2 GENERATED ALWAYS AS ROW START NOT NULL,
        SysEndTime DATETIME2 GENERATED ALWAYS AS ROW END NOT NULL,
        CONSTRAINT PK_Users PRIMARY KEY CLUSTERED (UserId),
        CONSTRAINT UK_Users_Email UNIQUE (Email),
        PERIOD FOR SYSTEM_TIME (SysStartTime, SysEndTime)
    ) WITH (SYSTEM_VERSIONING = ON (HISTORY_TABLE = dbo.UsersHistory));
END
GO

-- Sessions table - gerencia as sessões/tokens de autenticação
IF NOT EXISTS (SELECT * FROM sys.tables WHERE name = 'Sessions')
BEGIN
    CREATE TABLE Sessions (
        SessionId UNIQUEIDENTIFIER NOT NULL DEFAULT NEWID(),
        UserId UNIQUEIDENTIFIER NOT NULL,
        Token NVARCHAR(512) NOT NULL,
        ExpiresAt DATETIME2 NOT NULL,
        CreatedBy NVARCHAR(255) NOT NULL,
        CreatedDate DATETIME2 NOT NULL DEFAULT SYSUTCDATETIME(),
        ModifiedBy NVARCHAR(255) NOT NULL,
        ModifiedDate DATETIME2 NOT NULL DEFAULT SYSUTCDATETIME(),
        SysStartTime DATETIME2 GENERATED ALWAYS AS ROW START NOT NULL,
        SysEndTime DATETIME2 GENERATED ALWAYS AS ROW END NOT NULL,
        CONSTRAINT PK_Sessions PRIMARY KEY CLUSTERED (SessionId),
        CONSTRAINT FK_Sessions_Users FOREIGN KEY (UserId) REFERENCES Users(UserId),
        CONSTRAINT UK_Sessions_Token UNIQUE (Token),
        PERIOD FOR SYSTEM_TIME (SysStartTime, SysEndTime)
    ) WITH (SYSTEM_VERSIONING = ON (HISTORY_TABLE = dbo.SessionsHistory));
END
GO

-- ================================================================
-- 2. PROFILE & PERMISSIONS (Sistema de Controle de Acesso)
-- ================================================================

-- Profiles - Perfis de acesso (ex: Admin, Trader, Compliance, etc)
IF NOT EXISTS (SELECT * FROM sys.tables WHERE name = 'Profiles')
BEGIN
    CREATE TABLE Profiles (
        ProfileId UNIQUEIDENTIFIER NOT NULL DEFAULT NEWID(),
        ProfileName NVARCHAR(100) NOT NULL,
        Description NVARCHAR(500) NULL,
        CreatedBy NVARCHAR(255) NOT NULL,
        CreatedDate DATETIME2 NOT NULL DEFAULT SYSUTCDATETIME(),
        ModifiedBy NVARCHAR(255) NOT NULL,
        ModifiedDate DATETIME2 NOT NULL DEFAULT SYSUTCDATETIME(),
        SysStartTime DATETIME2 GENERATED ALWAYS AS ROW START NOT NULL,
        SysEndTime DATETIME2 GENERATED ALWAYS AS ROW END NOT NULL,
        CONSTRAINT PK_Profiles PRIMARY KEY CLUSTERED (ProfileId),
        CONSTRAINT UK_Profiles_ProfileName UNIQUE (ProfileName),
        PERIOD FOR SYSTEM_TIME (SysStartTime, SysEndTime)
    ) WITH (SYSTEM_VERSIONING = ON (HISTORY_TABLE = dbo.ProfilesHistory));
END
GO

-- Modules - Módulos da aplicação (ex: RFS, Portfolio, Voice, etc)
IF NOT EXISTS (SELECT * FROM sys.tables WHERE name = 'Modules')
BEGIN
    CREATE TABLE Modules (
        ModuleId UNIQUEIDENTIFIER NOT NULL DEFAULT NEWID(),
        ModuleName NVARCHAR(100) NOT NULL,
        ModuleCode NVARCHAR(50) NOT NULL, -- ex: 'RFS', 'PORTFOLIO', 'VOICE'
        Description NVARCHAR(500) NULL,
        CreatedBy NVARCHAR(255) NOT NULL,
        CreatedDate DATETIME2 NOT NULL DEFAULT SYSUTCDATETIME(),
        ModifiedBy NVARCHAR(255) NOT NULL,
        ModifiedDate DATETIME2 NOT NULL DEFAULT SYSUTCDATETIME(),
        SysStartTime DATETIME2 GENERATED ALWAYS AS ROW START NOT NULL,
        SysEndTime DATETIME2 GENERATED ALWAYS AS ROW END NOT NULL,
        CONSTRAINT PK_Modules PRIMARY KEY CLUSTERED (ModuleId),
        CONSTRAINT UK_Modules_ModuleCode UNIQUE (ModuleCode),
        PERIOD FOR SYSTEM_TIME (SysStartTime, SysEndTime)
    ) WITH (SYSTEM_VERSIONING = ON (HISTORY_TABLE = dbo.ModulesHistory));
END
GO

-- Functionalities - Funcionalidades/ações dentro dos módulos
IF NOT EXISTS (SELECT * FROM sys.tables WHERE name = 'Functionalities')
BEGIN
    CREATE TABLE Functionalities (
        FunctionalityId UNIQUEIDENTIFIER NOT NULL DEFAULT NEWID(),
        ModuleId UNIQUEIDENTIFIER NOT NULL,
        FunctionalityName NVARCHAR(100) NOT NULL,
        FunctionalityCode NVARCHAR(50) NOT NULL, -- ex: 'CREATE_CHANNEL', 'VIEW_ORDERS'
        Description NVARCHAR(500) NULL,
        CreatedBy NVARCHAR(255) NOT NULL,
        CreatedDate DATETIME2 NOT NULL DEFAULT SYSUTCDATETIME(),
        ModifiedBy NVARCHAR(255) NOT NULL,
        ModifiedDate DATETIME2 NOT NULL DEFAULT SYSUTCDATETIME(),
        SysStartTime DATETIME2 GENERATED ALWAYS AS ROW START NOT NULL,
        SysEndTime DATETIME2 GENERATED ALWAYS AS ROW END NOT NULL,
        CONSTRAINT PK_Functionalities PRIMARY KEY CLUSTERED (FunctionalityId),
        CONSTRAINT FK_Functionalities_Modules FOREIGN KEY (ModuleId) REFERENCES Modules(ModuleId),
        CONSTRAINT UK_Functionalities_Code UNIQUE (FunctionalityCode),
        PERIOD FOR SYSTEM_TIME (SysStartTime, SysEndTime)
    ) WITH (SYSTEM_VERSIONING = ON (HISTORY_TABLE = dbo.FunctionalitiesHistory));
END
GO

-- ProfilesXFunctionalities - Relacionamento entre Perfis e Funcionalidades
IF NOT EXISTS (SELECT * FROM sys.tables WHERE name = 'ProfilesXFunctionalities')
BEGIN
    CREATE TABLE ProfilesXFunctionalities (
        ProfileFunctionalityId UNIQUEIDENTIFIER NOT NULL DEFAULT NEWID(),
        ProfileId UNIQUEIDENTIFIER NOT NULL,
        FunctionalityId UNIQUEIDENTIFIER NOT NULL,
        CreatedBy NVARCHAR(255) NOT NULL,
        CreatedDate DATETIME2 NOT NULL DEFAULT SYSUTCDATETIME(),
        ModifiedBy NVARCHAR(255) NOT NULL,
        ModifiedDate DATETIME2 NOT NULL DEFAULT SYSUTCDATETIME(),
        SysStartTime DATETIME2 GENERATED ALWAYS AS ROW START NOT NULL,
        SysEndTime DATETIME2 GENERATED ALWAYS AS ROW END NOT NULL,
        CONSTRAINT PK_ProfilesXFunctionalities PRIMARY KEY CLUSTERED (ProfileFunctionalityId),
        CONSTRAINT FK_ProfilesXFunctionalities_Profiles FOREIGN KEY (ProfileId) REFERENCES Profiles(ProfileId),
        CONSTRAINT FK_ProfilesXFunctionalities_Functionalities FOREIGN KEY (FunctionalityId) REFERENCES Functionalities(FunctionalityId),
        CONSTRAINT UK_ProfilesXFunctionalities UNIQUE (ProfileId, FunctionalityId),
        PERIOD FOR SYSTEM_TIME (SysStartTime, SysEndTime)
    ) WITH (SYSTEM_VERSIONING = ON (HISTORY_TABLE = dbo.ProfilesXFunctionalitiesHistory));
END
GO

-- UsersXProfiles - Relacionamento entre Usuários e Perfis
IF NOT EXISTS (SELECT * FROM sys.tables WHERE name = 'UsersXProfiles')
BEGIN
    CREATE TABLE UsersXProfiles (
        UserProfileId UNIQUEIDENTIFIER NOT NULL DEFAULT NEWID(),
        UserId UNIQUEIDENTIFIER NOT NULL,
        ProfileId UNIQUEIDENTIFIER NOT NULL,
        CreatedBy NVARCHAR(255) NOT NULL,
        CreatedDate DATETIME2 NOT NULL DEFAULT SYSUTCDATETIME(),
        ModifiedBy NVARCHAR(255) NOT NULL,
        ModifiedDate DATETIME2 NOT NULL DEFAULT SYSUTCDATETIME(),
        SysStartTime DATETIME2 GENERATED ALWAYS AS ROW START NOT NULL,
        SysEndTime DATETIME2 GENERATED ALWAYS AS ROW END NOT NULL,
        CONSTRAINT PK_UsersXProfiles PRIMARY KEY CLUSTERED (UserProfileId),
        CONSTRAINT FK_UsersXProfiles_Users FOREIGN KEY (UserId) REFERENCES Users(UserId),
        CONSTRAINT FK_UsersXProfiles_Profiles FOREIGN KEY (ProfileId) REFERENCES Profiles(ProfileId),
        CONSTRAINT UK_UsersXProfiles UNIQUE (UserId, ProfileId),
        PERIOD FOR SYSTEM_TIME (SysStartTime, SysEndTime)
    ) WITH (SYSTEM_VERSIONING = ON (HISTORY_TABLE = dbo.UsersXProfilesHistory));
END
GO
